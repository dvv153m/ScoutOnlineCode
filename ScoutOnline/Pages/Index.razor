@page "/"

@using System.Drawing
@using BlazorLeaflet.Models

@attribute [Authorize]

@inject IJSRuntime jsRuntime
@inject ScoutOnline.Core.Map.MapsService MapService
@inject UnitService UnitService

<label style="margin-left:20px">Карта:</label>
<select @bind="CurrentMapType">
    @foreach (var map in MapService.Maps)
    {
        <option value="@map.Key">@map.Value.Title</option>
    }
</select>
<div id="mapContainer" style="margin-top:10px; width: 100%; height: 90vh;">
    <LeafletMap Map="_mapControl" />
</div>

@code{

    private Map _mapControl;

    private LatLng _mapCenterPosition = new LatLng(59.948080f, 30.326621f);

    private TileLayer CurrentLayer;

    private bool _isInitMap = false;

    private ScoutOnline.Core.Map.MapType _currentMapType = Core.Map.MapType.Openstreet;
    public ScoutOnline.Core.Map.MapType CurrentMapType
    {
        get { return _currentMapType; }
        set
        {
            if (_isInitMap)
            {
                _currentMapType = value;
                OnMapChange(_currentMapType);
            }
        }
    }

    private void OnMapChange(ScoutOnline.Core.Map.MapType mapType)
    {
        var newMap = MapService.Maps[mapType];
        _mapControl.RemoveLayer(CurrentLayer);

        InitCurrentLayer(newMap);

        _mapControl.AddLayer(CurrentLayer);
    }

    private ScopeModel[] scopesGroup;

    protected override async Task OnInitializedAsync()
    {
        //scopesGroup = await UnitService.GetScopes();
    }

    protected override void OnInitialized()
    {
        _mapControl = new Map(jsRuntime)
        {
            Center = _mapCenterPosition,
            Zoom = 7.8f
        };

        ScoutOnline.Core.Map.MapInfo map = MapService.Maps[_currentMapType];

        InitCurrentLayer(map);

        _mapControl.OnInitialized += () =>
        {
            _mapControl.AddLayer(CurrentLayer);
            _isInitMap = true;
        };
    }

    private void InitCurrentLayer(ScoutOnline.Core.Map.MapInfo map)
    {
        CurrentLayer = new TileLayer
        {
            UrlTemplate = map.BaseUrl,
            Subdomains = map.Subdomains,
            MaximumZoom = map.MaxZoom,
            Attribution = map.Attribution
        };
    }
}
