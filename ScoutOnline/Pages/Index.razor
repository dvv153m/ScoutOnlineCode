@page "/"
@page "/main"

@using System.Drawing
@using BlazorLeaflet.Models
@using ScoutOnline.Core.Geozone


@inject IJSRuntime jsRuntime
@inject ScoutOnline.Core.Map.MapsService MapService
@inject UnitService UnitService

<label style="margin-left:20px">Карта:</label>
<TelerikComboBox Data="MapService.Maps" TextField="Key" ValueField="Key" @bind-Value="CurrentMapType"></TelerikComboBox>

<div id="mapContainer" style="margin-top:10px; width: 100%; height: 90vh;">
    <LeafletMap Map="_mapControl" />
</div>

@code{
    private Map _mapControl;

    private LatLng _mapCenterPosition = new LatLng(59.948080f, 30.326621f);

    private TileLayer CurrentLayer;

    private bool _isInitMap = false;    

    private ScoutOnline.Core.Map.MapType _currentMapType = Core.Map.MapType.Openstreet;
    public ScoutOnline.Core.Map.MapType CurrentMapType
    {
        get { return _currentMapType; }
        set
        {
            if (_isInitMap)
            {
                _currentMapType = value;
                OnMapChange(_currentMapType);
            }
        }
    }

    private void OnMapChange(ScoutOnline.Core.Map.MapType mapType)
    {
        var newMap = MapService.Maps[mapType];
        _mapControl.RemoveLayer(CurrentLayer);

        InitCurrentLayer(newMap);

        _mapControl.AddLayer(CurrentLayer);
    }

    private ScopeModel[] scopesGroup;

    protected override async Task OnInitializedAsync()
    {
        //scopesGroup = await UnitService.GetScopes();
    }

    protected override void OnInitialized()
    {
        _mapControl = new Map(jsRuntime)
        {
            Center = _mapCenterPosition,
            Zoom = 7.8f
        };

        ScoutOnline.Core.Map.MapInfo map = MapService.Maps[_currentMapType];

        InitCurrentLayer(map);

        _mapControl.OnInitialized += () =>
        {
            _mapControl.AddLayer(CurrentLayer);

            var gPoints = new List<Location>()
            {
                new Location(59.948080f, 30.326621f),
                new Location(59.948080f, 30.346621f),
                new Location(59.938080f, 30.346621f),
                new Location(59.938080f, 30.326621f)
            };            
            var geozonePoints = GetGeozonePoints(gPoints);

            Polygon polyline = new Polygon { Shape = geozonePoints, DrawStroke= true, Fill=true, FillColor = Color.Blue };

            _mapControl.AddLayer(polyline);

            var area = Area.GetOuterArea(gPoints);
            if (area != null)
            {
                var center = area.Value.GetCenter();
                var marker = new Marker((float)center.Latitude, (float)center.Longitude);
                marker.Icon = new Icon() { Html = "geozone name 119" };
                _mapControl.AddLayer(marker);
            }

            _isInitMap = true;
        };
    }    

    private void InitCurrentLayer(ScoutOnline.Core.Map.MapInfo map)
    {
        CurrentLayer = new TileLayer
        {
            UrlTemplate = map.BaseUrl,
            Subdomains = map.Subdomains,
            MaximumZoom = map.MaxZoom,
            Attribution = map.Attribution
        };
    }

    private PointF[][] GetGeozonePoints(List<Location> gPoints)
    {
        PointF[][] points = new PointF[1][];

        if (gPoints == null)
        {
            points[0] = new PointF[0];
            return points;
        }
        
        points[0] = new PointF[gPoints.Count];

        for (int i = 0; i < gPoints.Count; i++)
        { 
            points[0][i] = new PointF((float)gPoints[i].Latitude, (float)gPoints[i].Longitude);
        }

        return points;
    }

    
}
